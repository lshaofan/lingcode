# Tasks: 语音录制功能实施清单

## 1. 基础依赖配置
- [ ] 1.1 添加 `cpal` 到 Cargo.toml (音频捕获)
- [ ] 1.2 添加 `hound` 到 Cargo.toml (WAV 处理)
- [ ] 1.3 添加 `tauri-plugin-global-shortcut` 到项目
- [ ] 1.4 配置 tauri.conf.json 麦克风权限
- [ ] 1.5 添加 macOS Info.plist 权限描述

## 2. 全局快捷键系统
- [ ] 2.1 集成 tauri-plugin-global-shortcut
- [ ] 2.2 实现快捷键注册和监听
- [ ] 2.3 实现快捷键配置存储到数据库
- [ ] 2.4 实现快捷键冲突检测
- [ ] 2.5 创建快捷键设置 UI 组件
- [ ] 2.6 实现快捷键修改功能
- [ ] 2.7 提供默认快捷键建议列表

## 3. 麦克风权限管理
- [ ] 3.1 实现 macOS 麦克风权限检查 (Objective-C 桥接)
- [ ] 3.2 创建权限申请引导 UI
- [ ] 3.3 实现权限状态检测 Tauri Command
- [ ] 3.4 创建权限被拒绝时的提示页面
- [ ] 3.5 实现跳转到系统设置的功能
- [ ] 3.6 在设置页面显示权限状态指示器

## 4. 音频录制引擎 (Rust)
- [ ] 4.1 创建 `src-tauri/src/audio/recorder.rs` 模块
- [ ] 4.2 实现 AudioRecorder 结构体
- [ ] 4.3 实现音频设备枚举功能
- [ ] 4.4 实现音频流捕获 (cpal)
- [ ] 4.5 实现 f32 到 i16 PCM 转换
- [ ] 4.6 实现 16kHz 重采样（如果需要）
- [ ] 4.7 实现音频缓冲区管理
- [ ] 4.8 实现实时音频数据发送到前端
- [ ] 4.9 处理音频流错误和恢复

## 5. Tauri Commands API
- [ ] 5.1 创建 `src-tauri/src/commands/audio.rs`
- [ ] 5.2 实现 `start_recording` Command
- [ ] 5.3 实现 `stop_recording` Command
- [ ] 5.4 实现 `cancel_recording` Command
- [ ] 5.5 实现 `get_audio_devices` Command
- [ ] 5.6 实现 `check_microphone_permission` Command
- [ ] 5.7 实现 `set_audio_device` Command
- [ ] 5.8 在 main.rs 中注册所有 Commands

## 6. 录音状态管理 (Zustand)
- [ ] 6.1 创建 `src/stores/recordingStore.ts`
- [ ] 6.2 定义录音状态类型 (idle, recording, processing)
- [ ] 6.3 实现开始录音 action
- [ ] 6.4 实现停止录音 action
- [ ] 6.5 实现取消录音 action
- [ ] 6.6 实现音频数据更新 action
- [ ] 6.7 实现录音时长计时
- [ ] 6.8 实现错误状态处理

## 7. 录音悬浮窗口
- [ ] 7.1 创建 `src/windows/recording/` 目录
- [ ] 7.2 创建 RecordingWindow.tsx 组件
- [ ] 7.3 实现波形可视化组件 (WaveformVisualizer)
- [ ] 7.4 实现时长显示组件
- [ ] 7.5 实现停止/取消按钮
- [ ] 7.6 实现窗口拖动功能
- [ ] 7.7 配置窗口样式 (半透明、圆角)
- [ ] 7.8 实现窗口关闭逻辑
- [ ] 7.9 添加录音动画效果
- [ ] 7.10 创建 recording.html 入口文件

## 8. 波形可视化
- [ ] 8.1 创建 WaveformVisualizer 组件
- [ ] 8.2 使用 Canvas API 绘制波形
- [ ] 8.3 监听 audio-data 事件
- [ ] 8.4 实现实时波形更新
- [ ] 8.5 优化渲染性能 (requestAnimationFrame)
- [ ] 8.6 添加波形颜色主题
- [ ] 8.7 实现音量指示器

## 9. VAD 语音活动检测
- [ ] 9.1 添加 `webrtc-vad` crate
- [ ] 9.2 创建 VAD 检测模块
- [ ] 9.3 实现静音检测逻辑
- [ ] 9.4 配置静音阈值和时长
- [ ] 9.5 集成到录音流程
- [ ] 9.6 实现 VAD 开关配置
- [ ] 9.7 创建 VAD 设置 UI
- [ ] 9.8 添加 VAD 状态指示

## 10. 音频数据导出
- [ ] 10.1 实现音频数据转 WAV 格式
- [ ] 10.2 实现音频数据转 Base64 (用于传输)
- [ ] 10.3 优化音频数据压缩
- [ ] 10.4 实现音频质量检测 (是否有效录音)
- [ ] 10.5 处理空录音或过短录音

## 11. 快捷键设置界面
- [ ] 11.1 在设置页面添加快捷键配置区域
- [ ] 11.2 创建快捷键输入组件
- [ ] 11.3 实现快捷键录制功能
- [ ] 11.4 显示快捷键冲突提示
- [ ] 11.5 提供快捷键重置功能
- [ ] 11.6 显示当前快捷键状态
- [ ] 11.7 添加快捷键帮助说明

## 12. 错误处理和降级
- [ ] 12.1 处理麦克风未找到错误
- [ ] 12.2 处理权限被拒绝错误
- [ ] 12.3 处理快捷键注册失败
- [ ] 12.4 处理音频流中断
- [ ] 12.5 实现错误提示 Toast
- [ ] 12.6 实现降级方案 (手动点击录音)
- [ ] 12.7 添加错误日志记录

## 13. 性能优化
- [ ] 13.1 优化音频缓冲区大小
- [ ] 13.2 优化实时数据传输频率
- [ ] 13.3 实现音频数据批量处理
- [ ] 13.4 优化波形渲染性能
- [ ] 13.5 监控内存占用
- [ ] 13.6 实现录音时长限制 (防止内存溢出)
- [ ] 13.7 添加性能监控指标

## 14. 测试
- [ ] 14.1 编写音频录制单元测试 (Rust)
- [ ] 14.2 编写格式转换测试
- [ ] 14.3 编写 VAD 检测测试
- [ ] 14.4 编写录音状态管理测试
- [ ] 14.5 编写 UI 组件测试 (RecordingWindow)
- [ ] 14.6 手动测试权限流程
- [ ] 14.7 手动测试快捷键功能
- [ ] 14.8 长时间录音压力测试
- [ ] 14.9 不同麦克风设备兼容性测试

## 15. 文档
- [ ] 15.1 编写音频模块 API 文档
- [ ] 15.2 编写快捷键使用文档
- [ ] 15.3 编写权限配置指南
- [ ] 15.4 更新 README 录音功能说明
- [ ] 15.5 添加故障排除文档
- [ ] 15.6 添加音频参数说明

## 16. 集成测试
- [ ] 16.1 测试完整录音流程 (快捷键 → 录音 → 停止)
- [ ] 16.2 测试与语音识别模块的集成
- [ ] 16.3 测试音频数据传递正确性
- [ ] 16.4 测试多次连续录音
- [ ] 16.5 测试窗口生命周期管理
- [ ] 16.6 测试状态同步
- [ ] 16.7 测试错误恢复

## 17. 用户体验优化
- [ ] 17.1 添加录音启动提示音
- [ ] 17.2 添加录音完成提示音
- [ ] 17.3 优化窗口动画效果
- [ ] 17.4 添加键盘快捷键提示
- [ ] 17.5 实现录音暂停倒计时
- [ ] 17.6 添加首次使用引导
- [ ] 17.7 优化错误提示文案

## 注意事项

### 依赖关系
- 任务 1 必须先完成才能开始其他任务
- 任务 2、3、4 可以并行开发
- 任务 7 依赖任务 6（需要状态管理）
- 任务 9 依赖任务 4（需要音频流）
- 任务 16 需要所有功能模块完成

### 优先级
- **P0 (核心)**: 任务 1-5, 6, 7, 10
- **P1 (重要)**: 任务 8, 9, 11, 14
- **P2 (优化)**: 任务 13, 17

### 时间估算
- 任务 1-3: 2-3 天
- 任务 4-5: 3-4 天
- 任务 6-8: 2-3 天
- 任务 9-13: 3-4 天
- 任务 14-17: 2-3 天
- **总计**: 约 3-4 周

### 技术难点
- macOS 权限申请需要 Objective-C 桥接
- 实时音频流处理性能优化
- VAD 参数调优
- 跨窗口状态同步

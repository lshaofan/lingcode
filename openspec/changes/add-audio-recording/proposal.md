# Proposal: 语音录制功能

## Why

「聆码」的核心功能是将语音转换为文字并自动插入，而语音录制是整个流程的第一步，也是最关键的用户交互入口。目前项目已完成基础设施搭建，但还缺少核心的音频捕获和处理能力。

### 用户需求
- 用户需要通过全局快捷键快速触发录音，无需切换到应用窗口
- 用户希望看到实时的录音状态反馈（波形、时长）
- 用户需要能够随时停止或取消录音
- 用户期望录音过程流畅，延迟低（<100ms）

### 技术必要性
- 需要访问系统麦克风硬件
- 需要实现全局快捷键监听（系统级）
- 需要音频流处理和格式转换
- 需要 VAD（语音活动检测）优化体验

## What Changes

### 新增功能
1. **全局快捷键系统**
   - 集成 `tauri-plugin-global-shortcut`
   - 支持自定义快捷键配置
   - 快捷键冲突检测和提示
   - 启动时自动注册快捷键

2. **麦克风权限管理**
   - macOS 麦克风权限申请流程
   - 权限状态检测和提示
   - 权限被拒绝时的降级方案

3. **音频录制引擎**
   - 使用 `cpal` (Rust) 或 `MediaRecorder API` 捕获音频
   - 支持 16kHz 采样率（Whisper 标准）
   - 实时音频流处理
   - 音频格式转换（WAV/PCM）

4. **录音悬浮窗**
   - 半透明、可拖动的悬浮窗口
   - 实时波形可视化
   - 录音时长显示
   - 停止/取消按钮

5. **VAD 语音检测**
   - 检测静音片段自动停止
   - 可配置静音阈值和时长
   - 降低无效录音

### 涉及的技术栈
- **Rust**: `cpal` 音频捕获库
- **Tauri Plugin**: `tauri-plugin-global-shortcut`
- **前端**: Web Audio API 用于波形可视化
- **状态管理**: Zustand 管理录音状态

## Impact

### 受影响的 Specs
- `audio-recording` (新增) - 音频录制核心逻辑
- `global-shortcut` (新增) - 全局快捷键管理
- `ui-framework` (修改) - 新增录音悬浮窗
- `data-storage` (修改) - 新增录音设置存储

### 受影响的代码
- `src-tauri/src/audio/` (新增) - Rust 音频处理模块
- `src-tauri/src/commands/audio.rs` (新增) - Tauri Commands
- `src/windows/recording/` (新增) - 录音窗口 UI
- `src/stores/recordingStore.ts` (新增) - 录音状态管理
- `src-tauri/tauri.conf.json` (修改) - 添加麦克风权限

### 依赖
- **系统权限**: macOS 麦克风权限
- **Rust Crates**:
  - `cpal` ^0.15 - 跨平台音频 I/O
  - `tauri-plugin-global-shortcut` ^2.0
  - `hound` ^3.5 - WAV 文件处理
  - `webrtc-vad` (可选) - VAD 检测

### 性能影响
- 内存占用: +20-50MB（录音缓冲区）
- CPU 占用: +5-15%（音频处理）
- 启动时间: +100-200ms（快捷键注册）

## Risks & Mitigation

### 风险 1: 麦克风权限被拒绝
- **影响**: 无法录音，核心功能不可用
- **缓解**:
  - 首次启动时引导用户授权
  - 提供详细的权限设置指引
  - 在设置页面显示权限状态
  - 提供手动跳转到系统设置的按钮

### 风险 2: 全局快捷键冲突
- **影响**: 用户设置的快捷键可能被系统或其他应用占用
- **缓解**:
  - 注册失败时提示用户
  - 提供常见冲突的提示信息
  - 允许用户自定义快捷键
  - 提供备用快捷键建议

### 风险 3: 音频延迟或卡顿
- **影响**: 影响用户体验，导致录音不完整
- **缓解**:
  - 使用低延迟音频 API
  - 优化音频缓冲区大小
  - 异步处理音频数据
  - 性能监控和降级方案

### 风险 4: 跨平台兼容性
- **影响**: 一期只支持 macOS，后续需要适配 Windows/Linux
- **缓解**:
  - 使用跨平台库（cpal）
  - 抽象音频接口，方便平台适配
  - 预留平台特定代码的接口

## Timeline

- **Week 1**: 全局快捷键 + 权限管理
- **Week 2**: 音频录制引擎 + 悬浮窗 UI
- **Week 3**: VAD 集成 + 性能优化
- **Week 4**: 测试 + Bug 修复

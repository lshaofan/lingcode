# Design: Operation Modes

## Context

「聆码」当前的工作流程是固定的：按快捷键 → 录制 → 处理中 → 显示结果 → 用户选择操作。这种单一流程无法适应不同用户场景的需求。我们需要添加两种操作模式，让用户根据使用场景灵活选择。

### 背景
- 用户反馈：有些场景需要快速输入，不想每次都预览确认
- 安全考虑：重要文档输入时，需要预览避免错误
- 性能优化：去除不必要的"处理中"状态，减少用户等待感

### 约束
- 必须向后兼容现有用户的使用习惯（默认预览模式）
- 不能增加系统复杂度，保持代码简洁
- 两种模式必须清晰易懂，不让用户困惑

## Goals / Non-Goals

### Goals
- 提供两种清晰的操作模式：直接插入和预览确认
- 简化录制状态，移除冗余的"处理中"状态
- 在设置页面提供易用的模式选择界面
- 确保模式切换立即生效

### Non-Goals
- 不支持更多的操作模式（如语音命令模式）
- 不实现模式的自动切换（如根据应用自动选择模式）
- 不提供模式相关的高级配置（如每个模式不同的快捷键）

## Decisions

### Decision 1: 数据模型
在 `Settings` 接口中添加 `operationMode: 'direct' | 'preview'` 字段。

**为什么选择这种方式：**
- 简单明确的字符串联合类型，类型安全
- 易于序列化到数据库和 localStorage
- 未来如需扩展，可以添加新的模式值

**替代方案：**
- 使用布尔值 `autoInsert: boolean`
  - 缺点：语义不明确，扩展性差

### Decision 2: 默认模式
默认使用"预览确认模式"（`preview`）。

**为什么选择这种方式：**
- 更安全：避免新用户误操作导致错误输入
- 符合当前用户习惯：现有流程接近预览模式
- 用户可以在熟悉后切换到直接模式

**替代方案：**
- 默认使用直接插入模式
  - 缺点：新用户可能不理解为什么会自动插入
- 首次启动时弹窗让用户选择
  - 缺点：增加用户负担

### Decision 3: 状态简化
移除独立的"处理中"状态，将转录过程合并到录制状态中。

**为什么选择这种方式：**
- 用户无需关心"录制结束"和"转录开始"之间的细微差别
- 减少状态切换，降低 UI 闪烁
- 转录速度快（< 2秒），不需要单独的等待状态

**状态流转设计：**
```
直接插入模式：
idle → recording → transcribing → inserting → idle

预览确认模式：
idle → recording → transcribing → preview → idle
```

**替代方案：**
- 保留"处理中"状态
  - 缺点：增加状态复杂度，UI 切换频繁

### Decision 4: 直接插入模式的 UI
在直接插入模式下，录制窗口仅显示最小化的信息（状态图标、时长、停止按钮），不显示文字预览区域。

**为什么选择这种方式：**
- 减少干扰：用户不需要看到文字内容
- 性能优化：不渲染文字内容区域
- 视觉简洁：符合"快速输入"的场景

**替代方案：**
- 两种模式使用相同的 UI
  - 缺点：直接模式下文字区域无用，浪费屏幕空间

### Decision 5: 插入失败的降级方案
在直接插入模式下，如果文本插入失败（如缺少辅助功能权限），自动降级为复制到剪贴板，并显示通知。

**为什么选择这种方式：**
- 提高可用性：即使没有权限，用户仍能使用功能
- 减少挫败感：避免用户录音后无法使用
- 明确提示：通知告知用户需要手动粘贴

**降级逻辑：**
```rust
match insert_text(text) {
    Ok(_) => show_notification("文字已插入"),
    Err(_) => {
        clipboard::set(text);
        show_notification("文字已复制到剪贴板，请手动粘贴 (Cmd+V)");
    }
}
```

### Decision 6: 设置 UI 设计
使用 RadioGroup 组件展示两种模式，每个选项包含：
- 模式名称（如"直接插入模式"）
- 简短说明（如"录制完成后自动插入文字，适合快速输入"）

**为什么选择这种方式：**
- 清晰明确：用户一眼看懂两种模式的区别
- 符合设计规范：与其他设置项保持一致
- 易于实现：复用现有的 RadioGroup 组件

**UI 布局：**
```
操作模式
○ 直接插入模式
  录制完成后自动插入文字到当前应用，适合快速输入场景

● 预览确认模式 (推荐)
  录制完成后先预览文字，由您决定是否插入，更加安全可控
```

## Risks / Trade-offs

### Risk 1: 直接插入模式可能导致误操作
- **风险**：用户在不合适的场景下使用直接插入模式，导致错误内容被输入
- **缓解**：
  - 默认使用预览模式
  - 在设置中明确标注直接模式的适用场景
  - 提供撤销功能（系统级 Cmd+Z）

### Risk 2: 用户可能不理解两种模式的区别
- **风险**：用户随意选择模式，导致体验不佳
- **缓解**：
  - 提供清晰的说明文字
  - 在预览模式上标注"推荐"
  - 考虑添加图示或动画演示（未来优化）

### Trade-off 1: 简化状态 vs 详细反馈
- **选择**：简化状态，移除"处理中"状态
- **权衡**：
  - 优点：减少 UI 切换，提升流畅度
  - 缺点：用户可能不知道转录正在进行
  - **解决**：在转录时显示简短的"转录中"提示

### Trade-off 2: 灵活性 vs 复杂度
- **选择**：只提供两种模式，不支持更多配置
- **权衡**：
  - 优点：简单易用，不增加复杂度
  - 缺点：无法满足所有用户的定制需求
  - **解决**：未来可根据用户反馈扩展功能

## Migration Plan

### 现有用户迁移
1. 现有用户在更新后，自动使用默认的"预览确认模式"
2. 行为与之前基本一致（除了移除"处理中"状态）
3. 用户可以在设置中切换到"直接插入模式"

### 数据迁移
- 新字段 `operationMode` 在数据库中默认为 `'preview'`
- 不需要迁移脚本，新字段在首次使用时自动创建

### 回滚计划
- 如果用户反馈不佳，可以在设置中隐藏模式选择
- 强制使用预览模式，恢复之前的行为

## Implementation Notes

### 前端实现要点
1. **设置页面**：
   - 在 `SystemSettings.tsx` 中添加 RadioGroup
   - 使用 `useSettingsStore` 读取和更新 `operationMode`

2. **录制窗口**：
   - 在 `RecordingFloat.tsx` 中根据 `operationMode` 条件渲染不同的 UI
   - 直接模式：隐藏文字预览区域和操作按钮
   - 预览模式：显示完整界面

3. **状态管理**：
   - 在 `recordingStore.ts` 中添加 `currentMode` 字段
   - 修改状态流转逻辑，移除 `processing` 状态

### 后端实现要点
1. **设置持久化**：
   - 在 Rust 后端添加 `operation_mode` 字段到 `settings` 表
   - 读取设置时返回 `operationMode`

2. **转录完成处理**：
   ```rust
   async fn on_transcription_complete(text: String, mode: OperationMode) {
       match mode {
           OperationMode::Direct => {
               // 尝试直接插入
               if let Err(_) = insert_text(&text).await {
                   // 降级到剪贴板
                   clipboard::set(&text);
                   emit_event("insertion-failed", text);
               }
           }
           OperationMode::Preview => {
               // 仅发送文本到前端显示
               emit_event("transcription-complete", text);
           }
       }
   }
   ```

### 关键代码路径
- `src/stores/settingsStore.ts` - 添加 `operationMode` 字段
- `src/windows/main/settings/SystemSettings.tsx` - 添加设置 UI
- `src/windows/recording/RecordingFloat.tsx` - 根据模式调整 UI
- `src/stores/recordingStore.ts` - 修改状态管理
- `src-tauri/src/commands/audio.rs` - 根据模式处理转录结果

## Open Questions

1. **是否需要为两种模式提供不同的快捷键？**
   - 当前决策：不需要，使用同一个快捷键
   - 理由：避免用户混淆，减少配置复杂度
   - 未来：可根据用户反馈考虑添加

2. **是否需要在首次使用时显示操作模式的引导？**
   - 当前决策：暂不实现，在设置中提供说明即可
   - 理由：避免打扰用户，减少开发工作量
   - 未来：可作为用户引导功能的一部分

3. **是否需要记录用户的模式切换历史？**
   - 当前决策：不需要
   - 理由：没有明确的使用场景，增加复杂度
   - 未来：可用于分析用户行为

## Success Criteria

- ✅ 用户可以在设置中选择操作模式
- ✅ 直接插入模式：录制完成后自动插入，无需手动操作
- ✅ 预览确认模式：录制完成后显示预览，用户手动选择操作
- ✅ 模式切换立即生效
- ✅ 移除"处理中"状态，状态流转流畅
- ✅ 插入失败时自动降级到剪贴板
- ✅ 设置持久化，重启后保持选择

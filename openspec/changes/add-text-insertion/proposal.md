# Proposal: 文本自动插入功能

## Why

文本自动插入是「聆码」的最后一公里，将转录的文字自动输入到用户当前活动的应用中。这是用户体验的关键，直接决定了工具的实用性。

### 用户需求
- 用户希望转录结果自动插入当前光标位置
- 用户不想手动复制粘贴
- 用户期望插入过程无感知（< 100ms）
- 用户需要支持各种应用（浏览器、编辑器、聊天工具等）

### 技术必要性
- 需要获取 macOS 辅助功能权限
- 需要检测当前活动窗口和应用
- 需要实现跨应用的文本插入
- 需要处理插入失败的降级方案

## What Changes

### 新增功能
1. **辅助功能权限管理**
   - macOS Accessibility 权限申请
   - 权限状态检测和提示
   - 权限被拒绝时的降级方案

2. **活动窗口检测**
   - 检测当前活动应用
   - 获取应用信息（Bundle ID, 名称）
   - 检测光标位置（可选）

3. **文本插入引擎**
   - 方案 A: 模拟键盘输入
   - 方案 B: 剪贴板粘贴
   - 方案 C: Accessibility API 插入
   - 自动降级机制

4. **插入策略**
   - 支持不同应用的特殊处理
   - 长文本分段插入
   - 特殊字符转义
   - 插入失败重试

5. **剪贴板管理**
   - 备份用户剪贴板内容
   - 插入后恢复剪贴板
   - 剪贴板历史（可选）

### 涉及的技术栈
- **Rust**: macOS Accessibility API 绑定
- **Objective-C**: 系统 API 桥接
- **Tauri**: 跨平台抽象层

## Impact

### 受影响的 Specs
- `clipboard-insertion` (新增) - 剪贴板插入策略
- `accessibility-permission` (新增) - 辅助功能权限管理

### 受影响的代码
- `src-tauri/src/insertion/` (新增) - 文本插入模块
- `src-tauri/src/commands/insertion.rs` (新增)
- `src/stores/insertionStore.ts` (新增)

### 依赖
- **系统权限**: macOS Accessibility (辅助功能)
- **Rust Crates**:
  - `enigo` ^0.2 - 键盘鼠标模拟
  - `clipboard` ^0.5 - 剪贴板操作
  - `core-foundation` - macOS API 绑定

### 性能影响
- 插入延迟: < 100ms
- CPU 占用: 可忽略

## Risks & Mitigation

### 风险 1: 辅助功能权限被拒绝
- **影响**: 无法自动插入文字
- **缓解**:
  - 降级到剪贴板方案
  - 提供详细权限引导
  - 显示手动粘贴提示

### 风险 2: 某些应用不支持自动输入
- **影响**: 文本插入失败
- **缓解**:
  - 维护应用兼容性列表
  - 提供多种插入方案
  - 失败时自动复制到剪贴板

### 风险 3: 插入速度慢导致卡顿
- **影响**: 用户感知延迟
- **缓解**:
  - 优化插入算法
  - 异步处理插入
  - 显示插入进度

## Timeline

- **Week 1**: 权限管理和窗口检测
- **Week 2**: 文本插入引擎
- **Week 3**: 兼容性测试和优化
